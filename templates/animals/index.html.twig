{% extends 'base.html.twig' %}

{% block title %}Nos rescapés{% endblock %}

{% block body %}
<div class="animals-page">
    <div class="container">
        <div class="page-header">
            <div class="header-content">
                <h1><i class="fas fa-heart"></i> Ils attendent une famille</h1>
                <p class="subtitle">Découvrez nos adorables pensionnaires qui rêvent de trouver leur foyer pour toujours</p>
            </div>
            {% if is_member %}
                <a href="{{ path('animals_add') }}" class="add-animal-btn">
                    <i class="fas fa-plus"></i> Ajouter un animal
                </a>
            {% endif %}
        </div>

        {# Section de filtres #}
        <div class="filters-section">
            <form method="GET" action="{{ path('animals') }}" class="filters-form">
                <div class="filter-field">
                    <select name="species" id="species-select">
                        <option value="">Type</option>
                        {% for species in allSpecies %}
                            <option value="{{ species.id }}" {% if currentSpecies == species.id %}selected{% endif %}>
                                {{ species.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <select name="sexe" id="sexe-select">
                        <option value="">Sexe</option>
                        <option value="male" {% if currentSexe == 'male' %}selected{% endif %}>Mâle</option>
                        <option value="femelle" {% if currentSexe == 'femelle' %}selected{% endif %}>Femelle</option>
                    </select>
                </div>

                <div class="filter-field">
                    <select name="department" id="department-select">
                        <option value="">Département</option>
                        {% for department in allDepartments %}
                            <option value="{{ department.id }}" {% if currentDepartment == department.id %}selected{% endif %}>
                                {{ department.code }} - {{ department.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit" class="filter-btn">
                    <i class="fas fa-filter"></i> Filtrer
                </button>

                {% if currentSpecies or currentSexe or currentDepartment %}
                    <a href="{{ path('animals') }}" class="reset-btn">
                        <i class="fas fa-times"></i> Réinitialiser
                    </a>
                {% endif %}
            </form>
        </div>

        {% if animals is empty %}
            <div class="empty-state">
                <div class="empty-content">
                    <i class="fas fa-paw"></i>
                    <h3>Aucun animal pour le moment</h3>
                    <p>Revenez bientôt pour découvrir nos nouveaux pensionnaires !</p>
                </div>
            </div>
        {% else %}
            <div class="animals-grid">
                {% for animal in animals %}
                    <div class="animal-card" data-animal-id="{{ animal.id }}">
                        <div class="card-image">
                            {% if animal.imageName %}
                                <img src="{{ asset('uploads/images/' ~ animal.imageName) }}" alt="{{ animal.name }}">
                            {% else %}
                                <div class="placeholder-image">
                                    {% if animal.species %}
                                        {% if animal.species.name|lower == 'chien' %}
                                            <i class="fas fa-dog"></i>
                                        {% elseif animal.species.name|lower == 'chat' %}
                                            <i class="fas fa-cat"></i>
                                        {% elseif animal.species.name|lower == 'lapin' %}
                                            <i class="fas fa-rabbit"></i>
                                        {% elseif animal.species.name|lower == 'oiseau' %}
                                            <i class="fas fa-dove"></i>
                                        {% else %}
                                            <i class="fas fa-paw"></i>
                                        {% endif %}
                                    {% else %}
                                        <i class="fas fa-paw"></i>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="card-content">
                            <div class="card-header">
                                <div class="name-and-special-tags">
                                    <h3 class="animal-name">{{ animal.name }}</h3>
                                    {% if animal.tag is not empty %}
                                        {% for tag in animal.tag %}
                                            {% if tag.type|lower == 'sos' or 'education' in tag.type|lower or tag.type|lower == 'fad' %}
                                                {% set tagClass = tag.type|lower|replace({' ': '-', '\'': '', 'é': 'e', 'è': 'e'}) %}
                                                {% set tagDescription = tag.description ?: 'Description non disponible' %}
                                                
                                                <span class="tag-mini {{ tagClass }}" 
                                                      data-tooltip="{{ tagDescription }}" 
                                                      data-tag-name="{{ tag.type }}">
                                                    {% if 'education' in tag.type|lower %}
                                                        <i class="fas fa-graduation-cap"></i>
                                                    {% elseif tag.type|lower == 'sos' %}
                                                        SOS
                                                    {% elseif tag.type|lower == 'fad' %}
                                                        FAD
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="animal-badges">
                                    {% if animal.species %}
                                        <span class="badge species-badge">{{ animal.species.name }}</span>
                                    {% endif %}
                                    <span class="badge age-badge">{{ animal.age }}</span>
                                    {% if animal.sexe == 'male' %}
                                        <span class="badge gender-badge male">
                                            <i class="fas fa-mars"></i> Mâle
                                        </span>
                                    {% else %}
                                        <span class="badge gender-badge female">
                                            <i class="fas fa-venus"></i> Femelle
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="separator"></div>
                            
                            <div class="animal-description">
                                <p class="description-text" data-full-text="{{ animal.description }}">
                                    {{ animal.description|length > 120 ? animal.description|slice(0, 120) ~ '...' : animal.description }}
                                </p>
                                {% if animal.description|length > 120 %}
                                    <button class="see-more-btn" data-animal-id="{{ animal.id }}">
                                        Voir plus
                                    </button>
                                {% endif %}
                            </div>
                            
                            {% set behavioralTags = [] %}
                            {% if animal.tag is not empty %}
                                {% for tag in animal.tag %}
                                    {% if not (tag.type|lower == 'sos' or 'education' in tag.type|lower or tag.type|lower == 'fad') %}
                                        {% set behavioralTags = behavioralTags|merge([tag]) %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            
                            {% if behavioralTags is not empty %}
                                <div class="animal-tags">
                                    {% for tag in behavioralTags|slice(0, 3) %}
                                        {% set tagClass = tag.type|lower|replace({' ': '-', '\'': '', 'é': 'e', 'è': 'e'}) %}
                                        <span class="tag {{ tagClass }}"
                                              data-tooltip="{{ tag.description }}"
                                              data-tag-name="{{ tag.type }}">
                                            {{ tag.type }}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <div class="card-actions">
                                <button class="action-btn favorite-btn {% if animal.id in user_favorite_ids %}favorited{% endif %}" data-animal-id="{{ animal.id }}" title="{% if animal.id in user_favorite_ids %}Retirer des favoris{% else %}Ajouter aux favoris{% endif %}">
                                    <i class="{% if animal.id in user_favorite_ids %}fas{% else %}far{% endif %} fa-heart"></i>
                                </button>
                                <button class="action-btn contact-btn" data-animal-id="{{ animal.id }}" title="Contacter l'association">
                                    <i class="fas fa-envelope"></i>
                                </button>
                            </div>
                            
                            {% if animal.association %}
                                <div class="association-info">
                                    <span class="association-name">{{ animal.association.name }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>

            {# Pagination #}
            <div class="pagination-wrapper">
                {{ knp_pagination_render(animals) }}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
