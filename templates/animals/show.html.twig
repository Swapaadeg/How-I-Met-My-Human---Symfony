{% extends 'base.html.twig' %}

{% block title %}{{ animal.name }} - Nos rescapés{% endblock %}

{% block body %}
<div class="animal-show-page">
    <div class="animal-show-container">
        {# Section principale avec photo circulaire et infos #}
        <div class="animal-profile-wrapper">
            {# Cercles rotatifs #}
            <div class="circle-container">
                <div class="circle-rotate"></div>
                <div class="circle-rotate2"></div>
            </div>

            {# Photo de profil circulaire #}
            <div class="profile-img">
                {% if animal.imageName %}
                    <img src="{{ asset('uploads/images/' ~ animal.imageName) }}" alt="{{ animal.name }}">
                {% else %}
                    <div class="placeholder-image">
                        {% if animal.species %}
                            {% if animal.species.name|lower == 'chien' %}
                                <i class="fas fa-dog"></i>
                            {% elseif animal.species.name|lower == 'chat' %}
                                <i class="fas fa-cat"></i>
                            {% elseif animal.species.name|lower == 'lapin' %}
                                <i class="fas fa-rabbit"></i>
                            {% elseif animal.species.name|lower == 'oiseau' %}
                                <i class="fas fa-dove"></i>
                            {% else %}
                                <i class="fas fa-paw"></i>
                            {% endif %}
                        {% else %}
                            <i class="fas fa-paw"></i>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            {# Nom (au-dessus) #}
            <div class="info-box info-nom">{{ animal.name }}</div>

            {# Sexe (gauche) #}
            <div class="info-box info-sexe">
                {% if animal.sexe == 'male' %}
                    <i class="fas fa-mars"></i> Mâle
                {% else %}
                    <i class="fas fa-venus"></i> Femelle
                {% endif %}
            </div>

            {# Âge (en haut à gauche) #}
            <div class="info-box info-age">{{ animal.age }}</div>

            {# Date d'arrivée (en haut à droite) #}
            <div class="info-box info-arrivee">
                Arrivée : {{ animal.dateArrivee|date('m/Y') }}
            </div>

            {# Association (droite) #}
            <div class="info-box info-asso">
                {% if animal.association %}
                    {{ animal.association.name }}
                {% else %}
                    Non renseigné
                {% endif %}
            </div>

            {# Ville (en bas) #}
            <div class="info-box info-ville">
                {% if animal.association and animal.association.codePostal %}
                    {{ animal.association.codePostal }}
                {% else %}
                    Lieu non renseigné
                {% endif %}
            </div>
        </div>

        {# Bouton favoris #}
        <button class="fav-button favorite-btn {% if is_favorited %}favorited{% endif %}" data-animal-id="{{ animal.id }}">
            <i class="{% if is_favorited %}fas{% else %}far{% endif %} fa-heart"></i>
        </button>

        {# Description #}
        <div class="animal-description-box">
            <p>{{ animal.description }}</p>
        </div>

        {# Tags comportementaux #}
        {% set behavioralTags = [] %}
        {% if animal.tag is not empty %}
            {% for tag in animal.tag %}
                {% if not (tag.type|lower == 'sos' or 'education' in tag.type|lower or tag.type|lower == 'fad') %}
                    {% set behavioralTags = behavioralTags|merge([tag]) %}
                {% endif %}
            {% endfor %}
        {% endif %}

        {% if behavioralTags is not empty %}
            <div class="animal-tags-section">
                <h3>Son caractère</h3>
                <div class="tags-container">
                    {% for tag in behavioralTags %}
                        {% set tagClass = tag.type|lower|replace({' ': '-', '\'': '', 'é': 'e', 'è': 'e'}) %}
                        <span class="tag {{ tagClass }}">
                            {{ tag.type }}
                        </span>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {# Boutons d'action #}
        <div class="action-buttons">
            <a href="{{ path('animals') }}" class="btn-back">
                <i class="fas fa-arrow-left"></i> Retour à la liste
            </a>
            {% if can_edit %}
                <a href="{{ path('animals_edit', {'id': animal.id}) }}" class="btn-edit">
                    <i class="fas fa-edit"></i> Modifier la fiche
                </a>
                <form method="post" action="{{ path('animals_delete', {'id': animal.id}) }}" style="display: inline;" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet animal ? Cette action est irréversible.');">
                    <button type="submit" class="btn-delete">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </form>
            {% endif %}
            {% if animal.association and animal.association.contactEmail %}
                <button class="btn-contact contact-btn" data-animal-id="{{ animal.id }}">
                    <i class="fas fa-envelope"></i> Contacter l'association
                </button>
            {% else %}
                <button class="btn-contact disabled" disabled>
                    <i class="fas fa-envelope"></i> Aucun contact disponible
                </button>
            {% endif %}
        </div>

        {# Section commentaires #}
        <div class="comments-section">
            <h3>Commentaires ({{ animal.comments|length }})</h3>

            {% if comment_form %}
                <div class="add-comment-form">
                    <div class="comment-user-info">
                        {% if app.user.imageName %}
                            <img src="{{ asset('uploads/images/' ~ app.user.imageName) }}" alt="{{ app.user.name }}" class="comment-avatar">
                        {% else %}
                            <div class="comment-avatar-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                        {% endif %}
                        <span class="comment-username">{{ app.user.name }}</span>
                    </div>

                    {{ form_start(comment_form, {'action': path('animal_comment_add', {'id': animal.id}), 'method': 'POST'}) }}
                    {{ form_widget(comment_form.text) }}
                    <button type="submit" class="btn-comment-submit">
                        <i class="fas fa-paper-plane"></i> Commenter
                    </button>
                    {{ form_end(comment_form) }}
                </div>
            {% else %}
                <p class="login-to-comment">
                    <a href="{{ path('auth') }}">Connectez-vous</a> pour laisser un commentaire
                </p>
            {% endif %}

            {# Affichage des commentaires #}
            <div class="comments-list">
                {% for comment in animal.comments %}
                    {% if comment.parent is null %}
                        <div class="comment comment-level-0" data-comment-id="{{ comment.id }}">
                            <div class="comment-header">
                                {% if comment.user.imageName %}
                                    <img src="{{ asset('uploads/images/' ~ comment.user.imageName) }}" alt="{{ comment.user.name }}" class="comment-avatar">
                                {% else %}
                                    <div class="comment-avatar-placeholder">
                                        <i class="fas fa-user"></i>
                                    </div>
                                {% endif %}
                                <div class="comment-meta">
                                    <strong class="comment-author">{{ comment.user.name }}</strong>
                                    <span class="comment-date">{{ comment.dateAjout|date('d/m/Y à H:i') }}</span>
                                </div>
                            </div>
                            <div class="comment-content">
                                {{ comment.text }}
                            </div>

                            {# Affichage des réponses imbriquées #}
                            {% if comment.replies|length > 0 %}
                                <div class="comment-replies">
                                    {% for reply in comment.replies %}
                                        <div class="comment comment-level-1" data-comment-id="{{ reply.id }}">
                                            <div class="comment-header">
                                                {% if reply.user.imageName %}
                                                    <img src="{{ asset('uploads/images/' ~ reply.user.imageName) }}" alt="{{ reply.user.name }}" class="comment-avatar">
                                                {% else %}
                                                    <div class="comment-avatar-placeholder">
                                                        <i class="fas fa-user"></i>
                                                    </div>
                                                {% endif %}
                                                <div class="comment-meta">
                                                    <strong class="comment-author">{{ reply.user.name }}</strong>
                                                    <span class="comment-date">{{ reply.dateAjout|date('d/m/Y à H:i') }}</span>
                                                </div>
                                            </div>
                                            <div class="comment-content">
                                                {{ reply.text }}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            {# Bouton pour répondre #}
                            {% if app.user %}
                                <div class="comment-actions">
                                    <button class="btn-reply" data-toggle-reply="{{ comment.id }}">
                                        <i class="fas fa-reply"></i> Répondre
                                    </button>
                                </div>

                                {# Formulaire de réponse (caché par défaut) #}
                                <div class="reply-form-container" id="reply-form-{{ comment.id }}" style="display: none;">
                                    <div class="reply-form-content">
                                        <form method="POST" action="{{ path('animal_comment_reply', {'id': animal.id, 'commentId': comment.id}) }}">
                                            <textarea name="comment_form_type[text]" placeholder="Écrivez votre réponse..." rows="2" class="comment-textarea"></textarea>
                                            <button type="submit" class="btn-comment-submit">
                                                <i class="fas fa-paper-plane"></i> Envoyer
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize favorite button
    const favoriteButton = document.querySelector('.favorite-btn');
    if (favoriteButton) {
        favoriteButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const animalId = this.dataset.animalId;
            const heartIcon = this.querySelector('i');

            // Toggle favorite state
            if (this.classList.contains('favorited')) {
                this.classList.remove('favorited');
                heartIcon.classList.remove('fas');
                heartIcon.classList.add('far');

                // Remove from favorites
                removeFavorite(animalId);
            } else {
                this.classList.add('favorited');
                heartIcon.classList.remove('far');
                heartIcon.classList.add('fas');

                // Add to favorites
                addFavorite(animalId);
            }

            // Add animation
            this.style.transform = 'scale(1.2)';
            setTimeout(() => {
                this.style.transform = '';
            }, 200);
        });
    }

    // Initialize reply toggles
    document.querySelectorAll('[data-toggle-reply]').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.toggleReply;
            const form = document.getElementById('reply-form-' + commentId);
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }
        });
    });
});

function addFavorite(animalId) {
    console.log(`Adding animal ${animalId} to favorites`);

    fetch('/api/favorites', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ animalId: animalId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Ajouté aux favoris !', 'success');
        } else {
            showNotification(data.message || 'Erreur lors de l\'ajout aux favoris', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Erreur lors de l\'ajout aux favoris', 'error');
    });
}

function removeFavorite(animalId) {
    console.log(`Removing animal ${animalId} from favorites`);

    fetch(`/api/favorites/${animalId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Retiré des favoris', 'info');
        } else {
            showNotification(data.message || 'Erreur lors de la suppression', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Erreur lors de la suppression', 'error');
    });
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notif => notif.remove());

    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;

    // Define colors based on type
    const colors = {
        success: '#10B981',
        error: '#EF4444',
        info: '#3B82F6',
        warning: '#F59E0B'
    };

    // Style the notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        font-weight: 500;
        animation: slideInRight 0.3s ease;
        max-width: 300px;
        font-size: 14px;
    `;

    // Add animation styles if not already present
    if (!document.querySelector('#notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }

    // Add to page
    document.body.appendChild(notification);

    // Remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}
</script>

{% endblock %}
